<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Know It All? ‚Äî Player</title>
  <style>
    :root{
      --bg:#070707;
      --border:#232323;
      --text:#f3f3f3;
      --muted:#bdbdbd;
      --orange:#ff7a18;
      --good:#29d17d;
      --bad:#ff4b4b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(255,122,24,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,122,24,.10), transparent 65%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
    }
    .wrap{max-width:820px;margin:0 auto;padding:18px 16px 30px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;border:1px solid var(--border);border-radius:18px;
      background:linear-gradient(180deg, rgba(17,17,17,.85), rgba(10,10,10,.65));
      box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:10;backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:950}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,154,61,.9), rgba(255,122,24,.35) 40%, rgba(0,0,0,.5) 75%),
        linear-gradient(180deg, rgba(255,122,24,.25), rgba(255,122,24,.06));
      border:1px solid rgba(255,122,24,.35);
      box-shadow: 0 12px 30px rgba(255,122,24,.12);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(10,10,10,.6); color:var(--muted); font-weight:900;
    }

    .card{
      margin-top:14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:linear-gradient(180deg, rgba(17,17,17,.75), rgba(9,9,9,.65));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .muted{color:var(--muted)}
    .small{font-size:12px}
    input{
      width:100%; padding:11px 12px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(8,8,8,.65);
      color:var(--text);
      outline:none;
      font-weight:900;
    }
    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(20,20,20,.9), rgba(10,10,10,.85));
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      font-weight:950; cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.12);border-color:rgba(255,122,24,.35)}
    .btn:active{transform:translateY(1px)}
    .btn.orange{
      border-color:rgba(255,122,24,.45);
      background:linear-gradient(180deg, rgba(255,122,24,.22), rgba(10,10,10,.88));
      box-shadow: 0 14px 40px rgba(255,122,24,.12);
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}

    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .qTitle{font-size:22px;font-weight:950;letter-spacing:.3px;line-height:1.25;margin:8px 0 10px}
    .answers{display:grid;gap:10px;grid-template-columns:1fr}
    .ans{
      text-align:left;border-radius:16px;padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,16,16,.85), rgba(8,8,8,.8));
      cursor:pointer;
      font-weight:950;
      color:var(--text);
      min-height:52px;
      transition: filter .12s ease, border-color .12s ease, transform .08s ease;
      user-select:none;
    }
    .ans:hover{filter:brightness(1.10);border-color:rgba(255,122,24,.30)}
    .ans:active{transform:translateY(1px)}
    .ans.selected{
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(8,8,8,.85));
      border-color: rgba(255,255,255,.35);
    }
    .ans.disabled{cursor:not-allowed;opacity:.35}
    .ans.wrongNow{border-color: rgba(255,75,75,.35); background: linear-gradient(180deg, rgba(255,75,75,.16), rgba(8,8,8,.85));}
    .ans.correctNow{border-color: rgba(41,209,125,.35); background: linear-gradient(180deg, rgba(41,209,125,.18), rgba(8,8,8,.85));}

    .timerBig{font-size:30px;font-weight:950;color:var(--orange);letter-spacing:1px}

    .statusBox{
      margin-top:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(10,10,10,.55);
      font-weight:900;
    }
    .statusBox.good{border-color: rgba(41,209,125,.30)}
    .statusBox.bad{border-color: rgba(255,75,75,.30)}

    .rulesBtn{
      position:fixed;right:16px;bottom:16px;z-index:1000;
      border-radius:999px;padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,122,24,.25), rgba(10,10,10,.85));
      border:1px solid rgba(255,122,24,.45);
      font-weight:980;cursor:pointer;
      box-shadow: 0 14px 44px rgba(255,122,24,.12);
      color:#fff;
    }

    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:999;
      padding:18px;
    }
    .modal{
      width:min(720px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,122,24,.35);
      background: linear-gradient(180deg, rgba(16,16,16,.92), rgba(8,8,8,.90));
      box-shadow: 0 25px 80px rgba(0,0,0,.6);
      padding:14px;
    }
    .modal .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .note{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.45}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-size:18px">Know It All?</div>
          <div class="small muted">Player Screen</div>
        </div>
      </div>
      <span class="pill">Room: <b id="roomCode">‚Äî</b></span>
    </div>

    <div class="card" id="joinCard">
      <h2 style="margin:6px 0 8px">Join Game</h2>
      <div class="muted small">Enter a nickname, then join the room.</div>
      <div class="divider"></div>

      <div class="row">
        <div style="flex:2">
          <label class="small muted">Nickname</label>
          <input id="nick" placeholder="e.g. Jaz, Tom, Mia..." maxlength="16"/>
        </div>
        <div style="flex:1;min-width:150px">
          <label class="small muted">Room code</label>
          <input id="roomInput" placeholder="ABCDE" maxlength="8"/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn orange" id="btnJoin">Join Game</button>
      </div>

      <div class="statusBox" id="joinStatus" style="display:none"></div>
    </div>

    <div class="card" id="waitCard" style="display:none">
      <h2 style="margin:6px 0 8px">Waiting for host...</h2>
      <div class="muted small">Players joined:</div>
      <div class="divider"></div>
      <div id="playersMini" class="muted">‚Äî</div>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="flex:1">
          <div class="muted small">Question</div>
          <div class="qTitle" id="qText">‚Äî</div>
        </div>
        <div style="text-align:right;min-width:140px">
          <div class="muted small">Timer</div>
          <div class="timerBig"><span id="timeLeft">20</span>s</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="answers" id="answers"></div>

      <div class="statusBox" id="revealResult" style="display:none"></div>
    </div>

    <div class="card" id="finalCard" style="display:none">
      <h2 style="margin:6px 0 8px" id="finalTitle">‚Äî</h2>
      <div class="muted" id="finalSub">‚Äî</div>
    </div>
  </div>

  <button class="rulesBtn" id="btnRules">Rules</button>

  <div class="modalBack" id="rulesBack">
    <div class="modal">
      <div class="modalTop">
        <h3>Rules & How to Play</h3>
        <button class="btn" id="rulesClose">Close</button>
      </div>
      <div class="note" style="font-size:13px;line-height:1.55;color:#e9e9e9">
        <b>Know It All?</b> is a fast-paced live quiz for up to <b>20 players</b> per room.<br><br>
        Tap one answer per question (it locks). Host reveals after timer. Speed earns more points.
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
      collection, query, orderBy, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClio_l3dpOesNw6tHNLDINOjWNDea0hSk",
      authDomain: "knowitall-a47a1.firebaseapp.com",
      projectId: "knowitall-a47a1",
      storageBucket: "knowitall-a47a1.firebasestorage.app",
      messagingSenderId: "975815651315",
      appId: "1:975815651315:web:7a5e981548448b382aec86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- RNG ----------
    function mulberry32(seed){
      return function(){
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function seededShuffle(arr, seed){
      const r = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(r()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    // ---------- Bank ----------
    let BANK=null;
    async function loadBank(){
      if(BANK) return BANK;
      const files = [
        "./question_bank_part1.json",
        "./question_bank_part2.json",
        "./question_bank_part3.json",
        "./question_bank_part4.json"
      ];
      const parts=[];
      for(const f of files){
        const res = await fetch(f, { cache:"no-store" });
        if(!res.ok) throw new Error("Missing file: " + f);
        parts.push(await res.json());
      }
      BANK = parts.flat();
      return BANK;
    }

    function isMathQuestion(q){
      const cat = String(q.category||"").toLowerCase();
      if(cat === "math" || cat === "maths") return true;
      const t = String(q.text||"").toLowerCase();
      const hasDigits = /\d/.test(t);
      const hasOps = /[+\-*/=]|√ó|√∑|\bplus\b|\bminus\b|\btimes\b|\bdivid(ed|e)\b|\bsolve\b|\bcalculate\b/.test(t);
      const looksLikeEquation = /(\d+\s*[+\-*/√ó√∑]\s*\d+)/.test(t);
      return (hasDigits && (hasOps || looksLikeEquation));
    }

    function buildQuestionSet(bank, total, seed){
      const mathsCap = Math.floor(total / 5);
      const maths = [];
      const non = [];
      for(const q of bank){
        (isMathQuestion(q) ? maths : non).push(q);
      }
      const m = seededShuffle(maths, seed + 11).slice(0, mathsCap);
      const n = seededShuffle(non, seed + 22).slice(0, total - m.length);
      return seededShuffle([...m, ...n], seed + 33);
    }

    function isNumericAnswer(ans){
      const s = String(ans).trim();
      return /^-?\d+(\.\d+)?$/.test(s);
    }

    function buildChoices(question, bank, seed, qIndex){
      const r = mulberry32(seed + qIndex * 1000 + 77);
      const correct = String(question.answer).trim();
      const wantNumber = isNumericAnswer(correct);

      let pool = bank
        .map(q => String(q.answer).trim())
        .filter(a => a && a !== correct)
        .filter(a => isNumericAnswer(a) === wantNumber);

      pool = Array.from(new Set(pool));

      const choices = [correct];
      while(choices.length < 4){
        if(pool.length){
          const idx = Math.floor(r() * pool.length);
          const pick = pool.splice(idx,1)[0];
          if(!choices.includes(pick)) choices.push(pick);
        } else {
          if(wantNumber){
            const n = Number(correct);
            const delta = (Math.floor(r()*9)+1) * (r() < 0.5 ? -1 : 1);
            const gen = String(Number.isFinite(n) ? (n + delta) : (Math.floor(r()*200)+1));
            if(!choices.includes(gen)) choices.push(gen);
          } else {
            const gen = "None of the above";
            if(!choices.includes(gen)) choices.push(gen);
          }
        }
      }
      return seededShuffle(choices, seed + qIndex * 17 + 123);
    }

    // ---------- UI ----------
    const joinCard = document.getElementById("joinCard");
    const waitCard = document.getElementById("waitCard");
    const gameCard = document.getElementById("gameCard");
    const finalCard = document.getElementById("finalCard");

    const roomCodeEl = document.getElementById("roomCode");
    const nickEl = document.getElementById("nick");
    const roomInputEl = document.getElementById("roomInput");
    const btnJoin = document.getElementById("btnJoin");
    const joinStatus = document.getElementById("joinStatus");

    const playersMini = document.getElementById("playersMini");
    const qTextEl = document.getElementById("qText");
    const answersEl = document.getElementById("answers");
    const timeLeftEl = document.getElementById("timeLeft");
    const revealResult = document.getElementById("revealResult");

    const finalTitle = document.getElementById("finalTitle");
    const finalSub = document.getElementById("finalSub");

    const rulesBack = document.getElementById("rulesBack");
    document.getElementById("btnRules").onclick = ()=> rulesBack.style.display="flex";
    document.getElementById("rulesClose").onclick = ()=> rulesBack.style.display="none";

    function show(screen){
      joinCard.style.display = (screen==="join") ? "" : "none";
      waitCard.style.display = (screen==="wait") ? "" : "none";
      gameCard.style.display = (screen==="game") ? "" : "none";
      finalCard.style.display = (screen==="final") ? "" : "none";
    }
    show("join");

    function qs(name){ return new URLSearchParams(location.search).get(name); }

    let roomCode = (qs("room")||"").toUpperCase();
    if(roomCode){
      roomInputEl.value = roomCode;
      roomCodeEl.textContent = roomCode;
    }

    let playerId = localStorage.getItem("kia_playerId") || null;
    function uuid(){ return "p_" + Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function safeNick(n){
      n = String(n||"").trim().replace(/\s+/g," ");
      if(n.length < 2) return null;
      return n.slice(0,16);
    }

    let roomRef=null, playerRef=null, playersCol=null;
    let tickTimer=null;
    let lastQIndex = null;
    let lockedChoice = null;

    btnJoin.onclick = async ()=>{
      const nick = safeNick(nickEl.value);
      const code = String(roomInputEl.value||"").trim().toUpperCase();
      if(!nick){
        joinStatus.style.display="";
        joinStatus.className="statusBox bad";
        joinStatus.textContent="Enter a nickname (2+ chars).";
        return;
      }
      if(!code){
        joinStatus.style.display="";
        joinStatus.className="statusBox bad";
        joinStatus.textContent="Enter a room code.";
        return;
      }

      roomCode = code;
      roomCodeEl.textContent = roomCode;

      roomRef = doc(db, "rooms", roomCode);
      playersCol = collection(db, "rooms", roomCode, "players");

      const snap = await getDoc(roomRef);
      if(!snap.exists()){
        joinStatus.style.display="";
        joinStatus.className="statusBox bad";
        joinStatus.textContent="Room not found.";
        return;
      }

      if(!playerId){
        playerId = uuid();
        localStorage.setItem("kia_playerId", playerId);
      }
      playerRef = doc(db, "rooms", roomCode, "players", playerId);

      await setDoc(playerRef, {
        nick,
        joinedAt: serverTimestamp(),
        score: 0,
        streak: 0,
        lastAnswer: null,
        lastAnswerMs: null,
        lastCorrect: null,
        cheatUsed: false,
        helpUsed: 0,
        pendingPerk: false,
        sabotagedNext: false
      }, { merge:true });

      joinStatus.style.display="none";
      bindListeners();
      show("wait");
    };

    async function getOrder(room){
      const bank = await loadBank();
      return buildQuestionSet(bank, room.questionCount || 50, room.seed);
    }

    function syncTimer(room){
      if(tickTimer) clearInterval(tickTimer);
      if(room.status === "question" && room.qStartMs){
        tickTimer = setInterval(()=>{
          const left = Math.max(0, Math.ceil((room.qStartMs + 20000 - Date.now())/1000));
          timeLeftEl.textContent = String(left);
        }, 150);
      } else {
        timeLeftEl.textContent = "20";
      }
    }

    function renderAnswers(room, me, q, choices){
      answersEl.innerHTML = "";
      const inQuestion = room.status === "question";
      lockedChoice = me.lastAnswer ?? lockedChoice;

      choices.forEach(choice=>{
        const btn = document.createElement("button");
        btn.className="ans";
        btn.textContent=choice;

        if(lockedChoice && String(lockedChoice).trim() === String(choice).trim()){
          btn.classList.add("selected");
        }

        if(!inQuestion || me.sabotagedNext){
          btn.classList.add("disabled");
          btn.disabled = true;
        }

        if(room.status === "reveal" || room.status === "awaitingPerks"){
          const correct = String(q.answer).trim();
          if(String(choice).trim() === correct) btn.classList.add("correctNow");
          else btn.classList.add("wrongNow");
          btn.disabled = true;
        }

        btn.onclick = async ()=>{
          if(!inQuestion) return;
          if(me.sabotagedNext) return;
          if(lockedChoice) return; // lock once picked

          lockedChoice = choice;
          await updateDoc(playerRef, { lastAnswer: choice, lastAnswerMs: Date.now() });

          // visual lock
          renderAnswers(room, { ...me, lastAnswer: choice }, q, choices);
        };

        answersEl.appendChild(btn);
      });
    }

    function renderFinal(room, me, players){
      const sorted = players.slice().sort((a,b)=>(b.score||0)-(a.score||0));
      const top = sorted[0]?.score || 0;
      const winners = sorted.filter(p=>(p.score||0)===top).map(p=>p.nick);
      const iWin = winners.includes(me.nick);

      finalTitle.textContent = iWin ? "You Know It All! üéâ" : "Not too bad! üôÇ";
      finalSub.textContent = iWin ? "You finished top!" : "Good effort ‚Äî try again!";
    }

    function bindListeners(){
      onSnapshot(roomRef, async (snap)=>{
        if(!snap.exists()){ show("join"); return; }
        const room = snap.data();

        const meSnap = await getDoc(playerRef);
        if(!meSnap.exists()) return;
        const me = meSnap.data();

        const pSnap = await getDocs(query(playersCol, orderBy("joinedAt","asc")));
        const players = pSnap.docs.map(d=>d.data());

        if(room.status === "lobby"){
          show("wait");
          playersMini.textContent = players.length ? players.map(p=>p.nick).join(", ") : "No other players yet.";
          return;
        }

        if(room.status === "final"){
          show("final");
          renderFinal(room, me, players);
          return;
        }

        show("game");

        const order = await getOrder(room);
        const qIndex = room.qIndex || 0;

        if(lastQIndex !== qIndex){
          lastQIndex = qIndex;
          lockedChoice = me.lastAnswer; // reset lock state per question
        }

        const q = order[qIndex];
        qTextEl.textContent = q?.text || "Question missing";

        const choices = buildChoices(q, order, room.seed, qIndex);
        renderAnswers(room, me, q, choices);
        syncTimer(room);

        if(room.status === "reveal" || room.status === "awaitingPerks"){
          revealResult.style.display="";
          revealResult.className = "statusBox " + (me.lastCorrect ? "good" : "bad");
          revealResult.textContent = me.lastCorrect ? "Correct ‚úÖ" : (me.sabotagedNext ? "Sabotaged" : "Incorrect ‚ùå");
        } else {
          revealResult.style.display="none";
        }
      });
    }
  </script>
</body>
</html>
