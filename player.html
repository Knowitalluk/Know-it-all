<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Know It All? — Player</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg0:#050506; --bg1:#0b0b10; --line: rgba(255,255,255,.10);
      --text:#f5f7ff; --muted: rgba(245,247,255,.70);
      --orange:#ff6a00; --orange2:#ff9a3d; --glow: rgba(255,106,0,.35);
      --good:#2cff9a; --bad:#ff3b5c; --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(255,106,0,.14), transparent 60%),
        radial-gradient(900px 500px at 80% 20%, rgba(255,154,61,.10), transparent 60%),
        radial-gradient(1200px 700px at 60% 90%, rgba(255,106,0,.08), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      min-height:100vh;
    }
    .container{ max-width:900px; margin:0 auto; padding:22px; }
    .brand h1{ margin:0; font-weight:1000; font-size:36px; letter-spacing:.5px; }
    .brand h1 span{ color:var(--orange); text-shadow:0 0 20px var(--glow); }
    .tag{ color:var(--muted); font-size:13px; letter-spacing:.18em; text-transform:uppercase; margin-top:6px; }

    .card{
      background: linear-gradient(180deg, rgba(15,17,23,.92), rgba(10,12,16,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 15px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,106,0,.06) inset;
      backdrop-filter: blur(10px);
      margin-top: 14px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,106,0,.35);
      background: rgba(255,106,0,.10);
      color: var(--orange2);
      box-shadow: 0 0 22px rgba(255,106,0,.12);
      font-weight:1000; letter-spacing:.04em;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .small{ color:var(--muted); font-size:13px; }

    input, button{
      font:inherit; border-radius:14px; padding:12px 12px; outline:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
    }
    input::placeholder{ color: rgba(245,247,255,.45); }
    button{
      cursor:pointer; font-weight:1000;
      border-color: rgba(255,106,0,.55);
      background: linear-gradient(180deg, rgba(255,106,0,.35), rgba(255,106,0,.12));
      box-shadow: 0 10px 30px rgba(255,106,0,.10);
    }
    button:disabled{ opacity:.35; cursor:not-allowed; }

    .btn-ghost{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      box-shadow:none;
      font-weight:900;
    }
    .btn-cheat{
      border-color: rgba(255,59,92,.45);
      background: linear-gradient(180deg, rgba(255,59,92,.18), rgba(255,59,92,.06));
    }

    .qtext{ font-size:30px; font-weight:1000; margin:10px 0 6px; }
    .answers{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:10px; }
    @media (max-width:520px){ .answers{ grid-template-columns:1fr; } }

    .answer{
      text-align:left; padding:14px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      position: relative;
      transition: transform .08s ease, border-color .08s ease, background .08s ease, box-shadow .08s ease;
    }
    .answer:active{ transform: scale(.99); }
    .answer.locked{ opacity:.55; cursor:not-allowed; }
    .answer.selected{
      border-color: rgba(255,255,255,.65);
      background: rgba(255,255,255,.10);
      box-shadow: 0 0 0 1px rgba(255,255,255,.18) inset, 0 10px 30px rgba(0,0,0,.25);
    }
    .answer.removed{
      border-color: rgba(255,59,92,.70);
      background: rgba(255,59,92,.14);
      opacity:.55;
      cursor:not-allowed;
    }

    .toast{
      margin-top:10px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,106,0,.25);
      background: rgba(255,106,0,.08);
      color: var(--orange2);
    }
    .toast.good{
      border-color: rgba(44,255,154,.35);
      background: rgba(44,255,154,.10);
      color: rgba(220,255,240,.95);
    }
    .toast.bad{
      border-color: rgba(255,59,92,.28);
      background: rgba(255,59,92,.10);
      color: rgba(255,220,228,.92);
    }

    .powerRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .powerRow button{ flex:1; min-width:160px; }

    .targetBox{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      overflow:hidden;
      display:none;
    }
    .targetBoxHeader{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .targetBtn{
      width:100%;
      border:0;
      border-radius: 0;
      background: transparent;
      box-shadow:none;
      border-bottom: 1px solid rgba(255,255,255,.07);
      text-align:left;
      padding: 12px 12px;
      cursor:pointer;
      color: var(--text);
    }
    .targetBtn:last-child{ border-bottom:0; }
    .targetBtn:hover{ background: rgba(255,106,0,.08); }
    .tLine{ display:flex; justify-content:space-between; align-items:center; gap:10px; color: var(--muted); }
    .tLine strong{ color: var(--text); }

    .kpi{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 8px; }
    .kpi .pill{
      padding: 10px 12px; border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      min-width: 150px;
    }
    .kpi .pill strong{ color: var(--text); display:block; }

    .lb{
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      display:none;
      background: rgba(255,255,255,.03);
    }
    .lbHeader{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      display:flex; justify-content:space-between; align-items:center;
    }
    .lbRow{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.07);
      color: var(--muted);
    }
    .lbRow:last-child{ border-bottom:0; }
    .lbRow strong{ color: var(--text); }
  </style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <h1>Know It <span>All?</span></h1>
      <div class="tag">PLAYER MODE • JOIN VIA QR</div>
    </div>

    <div class="card" id="joinCard">
      <div class="badge">Join Game</div>
      <p class="small">Enter nickname. Room code is auto-filled from the QR link.</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <input id="roomInput" class="mono" placeholder="ROOM CODE" style="flex:1; min-width:180px;" />
        <input id="nameInput" placeholder="Nickname" style="flex:1; min-width:160px;" />
        <button id="btnJoin">Join</button>
      </div>
      <div class="toast" id="joinToast" style="display:none;"></div>
    </div>

    <div class="card" id="waitCard" style="display:none;">
      <div class="badge">Waiting for Host…</div>
      <div class="qtext">Get Ready ⚡</div>
      <p class="small">The host will start the game soon.</p>
      <div class="kpi">
        <div class="pill"><strong>Status</strong><span class="mono" id="status">-</span></div>
        <div class="pill"><strong>Your Score</strong><span class="mono" id="score">0</span></div>
        <div class="pill"><strong>Your Streak</strong><span class="mono" id="streak">0</span></div>
      </div>
      <div class="toast bad" id="blockedToast" style="display:none;"></div>
    </div>

    <div class="card" id="playCard" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="badge" id="phaseBadge">Question</div>
        <div class="badge">Timer: <span class="mono" id="timer">20</span>s</div>
      </div>

      <div class="qtext" id="qText">Question</div>
      <div class="answers" id="answers"></div>

      <div class="powerRow">
        <button id="btnClaim" disabled>Claim +20</button>
        <button id="btnSabotage" disabled>Sabotage</button>
      </div>

      <div class="powerRow">
        <button id="btnCheat" class="btn-cheat" disabled>CHEAT (1)</button>
        <button id="btnHelp" disabled>HELP (3)</button>
      </div>

      <div class="targetBox" id="targetBox">
        <div class="targetBoxHeader">
          <span class="mono">Pick a player to jam</span>
          <button id="btnCancelTarget" class="btn-ghost" style="padding:8px 10px;">Cancel</button>
        </div>
        <div id="targetList"></div>
      </div>

      <div class="toast" id="resultToast" style="display:none;"></div>
      <div class="toast" id="playToast" style="display:none;"></div>

      <div class="lb" id="lbBox">
        <div class="lbHeader">
          <span class="mono">Leaderboard</span>
          <span class="mono" id="lbCount"></span>
        </div>
        <div id="lbRows"></div>
      </div>
    </div>

    <div class="card" id="finalCard" style="display:none;">
      <div class="badge">Final</div>
      <div style="font-size:44px; font-weight:1000; text-align:center; margin:12px 0;" id="finalTitle">You Know It All</div>
      <div style="text-align:center; letter-spacing:6px; color:var(--orange2);" id="finalSpark">✦ ✧ ✦ ✧ ✦</div>
      <p class="small" id="finalSub" style="text-align:center; margin-top:12px;"></p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyClio_l3dpOesNw6tHNLDINOjWNDea0hSk",
      authDomain: "knowitall-a47a1.firebaseapp.com",
      projectId: "knowitall-a47a1",
      storageBucket: "knowitall-a47a1.firebasestorage.app",
      messagingSenderId: "975815651315",
      appId: "1:975815651315:web:7a5e981548448b382aec86"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function nowMs(){ return Date.now(); }
    function fmtTimeLeft(endsAtMs){ return Math.max(0, Math.ceil((endsAtMs - nowMs())/1000)); }
    function $(id){ return document.getElementById(id); }
    function show(el,on=true){ el.style.display = on ? "" : "none"; }
    function setToast(el,msg,cls){
      el.className = "toast" + (cls ? (" " + cls) : "");
      if(!msg){ el.style.display="none"; el.textContent=""; }
      else { el.style.display=""; el.textContent=msg; }
    }
    function qparam(name){ return new URL(location.href).searchParams.get(name); }
    function labelAnswer(i){ return ["A","B","C","D"][i] || String(i+1); }

    let uid = null;
    let joined = false;

    let roomId = (qparam("room") || "").toUpperCase();

    let unsubRoom = null;
    let unsubPlayers = null;

    let latestRoom = null;
    let latestPlayers = [];

    let timerUI = null;

    let pickingTarget = false;

    // per-question local UI helpers
    const localHelpRemoved = new Map();   // key `${room}|${qIdx}` -> [idx,idx]
    const localSelected = new Map();      // key `${room}|${qIdx}` -> idx

    function roomRef(){ return db.collection("rooms").doc(roomId); }
    function playersRef(){ return roomRef().collection("players"); }
    function answersRef(){ return roomRef().collection("answers"); }

    async function signInPlayer(){
      const cred = await auth.signInAnonymously();
      uid = cred.user.uid;
    }

    async function joinGame(){
      roomId = ($("roomInput").value || "").trim().toUpperCase();
      const name = ($("nameInput").value || "").trim();
      if(!roomId || !name){
        setToast($("joinToast"), "Enter nickname (and ensure room code is present).");
        return;
      }

      const snap = await roomRef().get();
      if(!snap.exists){
        setToast($("joinToast"), "Room not found. Scan the QR again.");
        return;
      }

      await playersRef().doc(uid).set({
        id: uid,
        name,
        score: 0,
        streak: 0,
        rewardPending: false,
        rewardEarnedAtQuestionIndex: null,
        lastAnswer: null,
        cheatLeft: 1,
        helpLeft: 3,
        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      joined = true;
      setToast($("joinToast"), "");
      show($("joinCard"), false);
      show($("waitCard"), true);

      listenLive();
    }

    function isSabotaged(room){
      if(room.status !== "question") return false;
      const s = room.sabotage;
      if(!s || s.activeForQuestionIndex !== room.questionIndex) return false;
      const blocks = s.blocks || [];
      return blocks.some(b => b.targetPlayerId === uid);
    }

    function isPendingStreakDecision(room, me){
      if(room.status !== "reveal") return false;
      if(!room.pause || room.pause.type !== "streak") return false;
      const pending = room.pause.pendingPlayerIds || [];
      return me && me.rewardPending === true && pending.includes(uid);
    }

    async function alreadyAnswered(qIdx){
      const doc = await answersRef().doc(`${qIdx}_${uid}`).get();
      return doc.exists;
    }

    async function submitAnswer(choiceIndex){
      if(!latestRoom) return;
      if(latestRoom.status !== "question") return;
      if(isSabotaged(latestRoom)) return;

      const key = `${roomId}|${latestRoom.questionIndex}`;
      localSelected.set(key, choiceIndex);
      renderAnswers(); // immediate highlight

      if(await alreadyAnswered(latestRoom.questionIndex)) return;

      await answersRef().doc(`${latestRoom.questionIndex}_${uid}`).set({
        id: `${latestRoom.questionIndex}_${uid}`,
        uid,
        roomId,
        questionIndex: latestRoom.questionIndex,
        choiceIndex,
        answeredAtMs: nowMs()
      });

      setToast($("playToast"), "Answer locked in.");
    }

    async function claim20(){
      if(!latestRoom) return;
      const meSnap = await playersRef().doc(uid).get();
      if(!meSnap.exists) return;
      const me = meSnap.data();
      if(!isPendingStreakDecision(latestRoom, me)) return;

      // transaction: remove me from pending list and add points
      await db.runTransaction(async (tx) => {
        const roomDoc = await tx.get(roomRef());
        const meDoc = await tx.get(playersRef().doc(uid));
        if(!roomDoc.exists || !meDoc.exists) return;

        const room = roomDoc.data();
        const player = meDoc.data();

        const pending = (room.pause?.pendingPlayerIds || []).slice();
        if(!pending.includes(uid)) return;

        const newPending = pending.filter(x => x !== uid);

        tx.update(playersRef().doc(uid), {
          score: (player.score||0) + 20,
          rewardPending: false,
          rewardEarnedAtQuestionIndex: null,
          streak: 0
        });

        tx.update(roomRef(), {
          pause: newPending.length ? { ...room.pause, pendingPlayerIds: newPending } : null,
          updatedAtMs: nowMs()
        });
      });

      pickingTarget = false;
      show($("targetBox"), false);
    }

    async function openSabotage(){
      if(!latestRoom) return;
      const meSnap = await playersRef().doc(uid).get();
      if(!meSnap.exists) return;
      const me = meSnap.data();
      if(!isPendingStreakDecision(latestRoom, me)) return;

      pickingTarget = true;
      show($("targetBox"), true);
      await renderTargets();
    }

    async function applySabotage(targetId){
      if(!latestRoom) return;

      await db.runTransaction(async (tx) => {
        const roomDoc = await tx.get(roomRef());
        const meDoc = await tx.get(playersRef().doc(uid));
        if(!roomDoc.exists || !meDoc.exists) return;

        const room = roomDoc.data();
        const me = meDoc.data();

        const pending = (room.pause?.pendingPlayerIds || []).slice();
        if(!pending.includes(uid)) return;

        const newPending = pending.filter(x => x !== uid);

        // add block for NEXT question (multiple sabotages allowed)
        const nextQ = room.questionIndex + 1;
        let sabotage = room.sabotage;

        if(!sabotage || sabotage.activeForQuestionIndex !== nextQ){
          sabotage = { activeForQuestionIndex: nextQ, blocks: [] };
        }

        const blocks = Array.isArray(sabotage.blocks) ? sabotage.blocks.slice() : [];
        blocks.push({ targetPlayerId: targetId, byName: me.name });

        tx.update(roomRef(), {
          sabotage: { activeForQuestionIndex: nextQ, blocks },
          pause: newPending.length ? { ...room.pause, pendingPlayerIds: newPending } : null,
          updatedAtMs: nowMs()
        });

        tx.update(playersRef().doc(uid), {
          rewardPending: false,
          rewardEarnedAtQuestionIndex: null,
          streak: 0
        });
      });

      pickingTarget = false;
      show($("targetBox"), false);
    }

    async function cheat(){
      if(!latestRoom) return;
      if(latestRoom.status !== "question") return;
      if(isSabotaged(latestRoom)) return;

      const meSnap = await playersRef().doc(uid).get();
      if(!meSnap.exists) return;
      const me = meSnap.data();

      if(me.rewardPending) return;
      if((me.cheatLeft||0) <= 0) return;
      if(await alreadyAnswered(latestRoom.questionIndex)) return;

      await playersRef().doc(uid).update({ cheatLeft: (me.cheatLeft||0) - 1 });

      // submit correct answer + highlight instantly
      const correctIndex = latestRoom.currentQuestion.correctIndex;
      const key = `${roomId}|${latestRoom.questionIndex}`;
      localSelected.set(key, correctIndex);
      renderAnswers();
      await submitAnswer(correctIndex);
    }

    async function help5050(){
      if(!latestRoom) return;
      if(latestRoom.status !== "question") return;
      if(isSabotaged(latestRoom)) return;

      const meSnap = await playersRef().doc(uid).get();
      if(!meSnap.exists) return;
      const me = meSnap.data();

      if(me.rewardPending) return;
      if((me.helpLeft||0) <= 0) return;
      if(await alreadyAnswered(latestRoom.questionIndex)) return;

      const key = `${roomId}|${latestRoom.questionIndex}`;
      if(localHelpRemoved.has(key)) return;

      const correct = latestRoom.currentQuestion.correctIndex;
      const wrong = [];
      for(let i=0;i<latestRoom.currentQuestion.options.length;i++){
        if(i !== correct) wrong.push(i);
      }
      wrong.sort(()=>Math.random()-0.5);
      localHelpRemoved.set(key, wrong.slice(0,2));

      await playersRef().doc(uid).update({ helpLeft: (me.helpLeft||0) - 1 });

      // NEW: redraw immediately so wrong answers go red now
      renderAnswers();
    }

    async function renderTargets(){
      const list = $("targetList");
      list.innerHTML = "";

      const players = latestPlayers
        .filter(p => p.id !== uid)
        .sort((a,b)=> (b.score - a.score) || (a.name||"").localeCompare(b.name||""));

      if(players.length === 0){
        const div = document.createElement("div");
        div.style.padding = "12px";
        div.className = "small";
        div.textContent = "No players available.";
        list.appendChild(div);
        return;
      }

      players.forEach((p,i)=>{
        const btn = document.createElement("button");
        btn.className = "targetBtn";
        btn.innerHTML = `<div class="tLine"><div><strong>${p.name}</strong> <span class="small mono" style="opacity:.75">#${i+1}</span></div><span class="mono">${p.score||0}</span></div>`;
        btn.onclick = () => applySabotage(p.id);
        list.appendChild(btn);
      });
    }

    function renderLeaderboard(){
      const box = $("lbBox");
      const rows = $("lbRows");

      if(!latestRoom || latestRoom.status !== "reveal"){
        box.style.display = "none";
        rows.innerHTML = "";
        return;
      }

      box.style.display = "";
      $("lbCount").textContent = `${latestPlayers.length} players`;

      rows.innerHTML = "";
      latestPlayers
        .slice()
        .sort((a,b)=> (b.score - a.score) || (a.name||"").localeCompare(b.name||""))
        .forEach((p, i)=>{
          const div = document.createElement("div");
          div.className = "lbRow";
          div.innerHTML = `<div><span class="mono" style="opacity:.7">#${i+1}</span> <strong>${p.name||"Player"}</strong></div><div class="mono">${p.score||0}</div>`;
          rows.appendChild(div);
        });
    }

    function renderAnswers(){
      if(!latestRoom) return;

      const ansBox = $("answers");
      ansBox.innerHTML = "";

      const q = latestRoom.currentQuestion;
      if(!q) return;

      const key = `${roomId}|${latestRoom.questionIndex}`;
      const removed = localHelpRemoved.get(key) || [];
      const selected = localSelected.get(key);

      const lockedForGame = latestRoom.status !== "question";
      const sabotaged = isSabotaged(latestRoom);

      // also lock if I’m currently choosing streak reward
      const me = latestPlayers.find(p=>p.id===uid);
      const lockedForStreak = latestRoom.status === "reveal" && me && me.rewardPending;

      q.options.forEach((opt, idx)=>{
        const b = document.createElement("button");
        b.className = "answer";

        if(typeof selected === "number" && selected === idx){
          b.classList.add("selected");
        }
        if(removed.includes(idx)){
          b.classList.add("removed");
          b.disabled = true;
        }

        const locked = lockedForGame || sabotaged || lockedForStreak;
        if(locked){
          b.classList.add("locked");
          b.disabled = true;
        }else{
          b.onclick = () => submitAnswer(idx);
        }

        b.innerHTML = `<div class="small mono">${labelAnswer(idx)}</div><div style="font-weight:1000;margin-top:4px;">${opt}</div>`;
        ansBox.appendChild(b);
      });
    }

    function listenLive(){
      if(unsubRoom) unsubRoom();
      if(unsubPlayers) unsubPlayers();

      unsubRoom = roomRef().onSnapshot(async (snap)=>{
        if(!snap.exists) return;
        latestRoom = snap.data();

        // basic page visibility
        show($("joinCard"), !joined);
        show($("waitCard"), joined && latestRoom.status === "lobby");
        show($("playCard"), joined && (latestRoom.status === "question" || latestRoom.status === "reveal"));
        show($("finalCard"), joined && latestRoom.status === "final");

        $("status").textContent = latestRoom.status;
        $("phaseBadge").textContent = latestRoom.status === "reveal" ? "Reveal" : "Question";

        // timer
        if(timerUI) clearInterval(timerUI);
        if(latestRoom.status === "question" || latestRoom.status === "reveal"){
          timerUI = setInterval(()=> $("timer").textContent = String(fmtTimeLeft(latestRoom.questionEndsAt)), 150);
        }

        // question text
        $("qText").textContent = latestRoom.currentQuestion?.text || "Question";

        // sabotage message
        if(joined && isSabotaged(latestRoom)){
          const blocks = latestRoom.sabotage?.blocks || [];
          const hit = blocks.find(b=>b.targetPlayerId === uid);
          setToast($("blockedToast"), `⚠ You have been sabotaged by ${hit?.byName || "a player"}. You cannot answer this question.`, "bad");
        }else{
          setToast($("blockedToast"), "", "bad");
        }

        // render answers + leaderboard if available
        renderAnswers();
        renderLeaderboard();

        // update me info + buttons
        const meSnap = await playersRef().doc(uid).get();
        const me = meSnap.exists ? meSnap.data() : null;
        if(me){
          $("score").textContent = String(me.score||0);
          $("streak").textContent = String(me.streak||0);
          $("btnCheat").textContent = `CHEAT (${me.cheatLeft||0})`;
          $("btnHelp").textContent = `HELP (${me.helpLeft||0})`;
        }

        const pendingForMe = isPendingStreakDecision(latestRoom, me);

        $("btnClaim").disabled = !pendingForMe;
        $("btnSabotage").disabled = !pendingForMe;

        const canAct = latestRoom.status === "question" && !isSabotaged(latestRoom) && me && !me.rewardPending;
        $("btnCheat").disabled = !(canAct && (me?.cheatLeft||0) > 0);
        $("btnHelp").disabled  = !(canAct && (me?.helpLeft||0) > 0);

        // toasts: reveal result
        if(latestRoom.status === "reveal" && me && me.lastAnswer && me.lastAnswer.questionIndex === latestRoom.questionIndex){
          if(me.lastAnswer.isCorrect){
            setToast($("resultToast"), `✅ Correct! +${me.lastAnswer.pointsAwarded || 0} points`, "good");
          }else{
            setToast($("resultToast"), `❌ Wrong answer.`, "bad");
          }
        }else{
          setToast($("resultToast"), "", "");
        }

        // toasts: streak decision
        if(pendingForMe && pickingTarget){
          setToast($("playToast"), "Pick a player to sabotage.", "");
          show($("targetBox"), true);
          await renderTargets();
        }else if(pendingForMe){
          setToast($("playToast"), "5-streak unlocked! Claim +20 or Sabotage.", "");
          show($("targetBox"), false);
        }else if(latestRoom.status === "reveal" && latestRoom.pause && (latestRoom.pause.pendingPlayerIds||[]).length>0){
          setToast($("playToast"), `Paused: waiting for ${latestRoom.pause.pendingPlayerIds.length} streak decision(s)…`, "");
          show($("targetBox"), false);
        }else{
          setToast($("playToast"), "", "");
          show($("targetBox"), false);
          pickingTarget = false;
        }

        // final screen text
        if(latestRoom.status === "final" && me){
          const winners = latestRoom.winners || [];
          const isWinner = winners.includes(uid);
          $("finalTitle").textContent = isWinner ? "You Know It All" : "Not too bad!";
          $("finalSpark").textContent = isWinner ? "✦ ✧ ✦ ✧ ✦" : "☹";
          $("finalSub").textContent = `Final score: ${me.score||0}`;
        }

      }, (err)=>console.error("Room listener error:", err));

      // Live players list for leaderboard + sabotage target list
      unsubPlayers = playersRef().onSnapshot((snap)=>{
        latestPlayers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderLeaderboard();
        renderAnswers();
      }, (err)=>console.error("Players listener error:", err));
    }

    $("btnJoin").onclick = joinGame;
    $("btnClaim").onclick = claim20;
    $("btnSabotage").onclick = openSabotage;
    $("btnCancelTarget").onclick = () => { pickingTarget = false; show($("targetBox"), false); };
    $("btnCheat").onclick = cheat;
    $("btnHelp").onclick = help5050;

    (async function init(){
      await signInPlayer();
      if(roomId) $("roomInput").value = roomId;
    })();
  </script>
</body>
</html>

