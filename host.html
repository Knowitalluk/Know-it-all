<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Know It All? — Host</title>

  <style>
    :root{
      --bg:#070707;
      --panel:#0e0e0e;
      --border:#232323;
      --text:#f3f3f3;
      --muted:#bdbdbd;
      --orange:#ff7a18;
      --good:#29d17d;
      --bad:#ff4b4b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(255,122,24,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,122,24,.10), transparent 65%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
    }

    .wrap{
      max-width: 1920px;
      margin:0 auto;
      padding: 14px 14px 22px;
    }

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(17,17,17,.85), rgba(10,10,10,.65));
      box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:950}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,154,61,.9), rgba(255,122,24,.35) 40%, rgba(0,0,0,.5) 75%),
        linear-gradient(180deg, rgba(255,122,24,.25), rgba(255,122,24,.06));
      border:1px solid rgba(255,122,24,.35);
      box-shadow: 0 12px 30px rgba(255,122,24,.12);
    }
    .brand .t1{font-size:18px}
    .brand .t2{font-size:12px;color:var(--muted);font-weight:700;margin-top:-2px}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(10,10,10,.6); color:var(--muted); font-weight:900;
    }

    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(20,20,20,.9), rgba(10,10,10,.85));
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      font-weight:950; cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.12);border-color:rgba(255,122,24,.35)}
    .btn:active{transform:translateY(1px)}
    .btn.orange{
      border-color:rgba(255,122,24,.45);
      background:linear-gradient(180deg, rgba(255,122,24,.22), rgba(10,10,10,.88));
      box-shadow: 0 14px 40px rgba(255,122,24,.12);
    }
    .btn.danger{
      border-color: rgba(255,75,75,.35);
      background: linear-gradient(180deg, rgba(255,75,75,.20), rgba(10,10,10,.88));
    }
    .btn:disabled{opacity:.45;cursor:not-allowed;filter:saturate(.6)}

    /* 1080p host layout: left main + right always-leaderboard */
    .layout{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:1100px){
      .layout{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:linear-gradient(180deg, rgba(17,17,17,.75), rgba(9,9,9,.65));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:6px 0 10px;font-size:16px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input, select{
      width:100%;
      padding:11px 12px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(8,8,8,.65);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    /* QR block */
    .qrWrap{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
    #qr{
      width:188px;height:188px;border-radius:18px;background:#fff;padding:10px;
      border:2px solid rgba(255,122,24,.85);
      box-shadow: 0 12px 35px rgba(255,122,24,.18);
      overflow:hidden;
    }

    /* Game panel */
    .qTitle{font-size:22px;font-weight:950;letter-spacing:.3px;line-height:1.25;margin:8px 0 10px}
    .answers{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:720px){.answers{grid-template-columns:1fr}}
    .ansBtn{
      text-align:left;border-radius:16px;padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,16,16,.85), rgba(8,8,8,.8));
      font-weight:950;color:var(--text);
      min-height:50px;
      opacity:.95;
    }
    .ansBtn.correct{
      border-color: rgba(41,209,125,.35);
      background: linear-gradient(180deg, rgba(41,209,125,.18), rgba(8,8,8,.85));
    }
    .ansBtn.wrong{opacity:.55}

    .timerBig{font-size:28px;font-weight:950;color:var(--orange);letter-spacing:1px}
    .hostControls{display:flex;gap:10px;flex-wrap:wrap}
    .hostControls .btn{flex:1 1 160px}

    /* Players list / leaderboard */
    .plist{display:flex;flex-direction:column;gap:8px;max-height: calc(100vh - 210px); overflow:auto; padding-right:6px}
    .pitem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(10,10,10,.5);
    }
    .pname{font-weight:950}
    .psub{font-size:12px;color:var(--muted);font-weight:800}
    .pscore{font-weight:980;color:var(--orange)}
    .tag{font-size:12px;font-weight:950;color:#000;background:var(--orange);padding:4px 8px;border-radius:999px}
    .tag.bad{background:var(--bad); color:#fff}
    .tag.good{background:var(--good); color:#000}

    /* Rules floating button */
    .rulesBtn{
      position:fixed;right:16px;bottom:16px;z-index:1000;
      border-radius:999px;padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,122,24,.25), rgba(10,10,10,.85));
      border:1px solid rgba(255,122,24,.45);
      font-weight:980;cursor:pointer;
      box-shadow: 0 14px 44px rgba(255,122,24,.12);
    }

    /* Modal */
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:999;
      padding:18px;
    }
    .modal{
      width:min(740px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,122,24,.35);
      background: linear-gradient(180deg, rgba(16,16,16,.92), rgba(8,8,8,.90));
      box-shadow: 0 25px 80px rgba(0,0,0,.6);
      padding:14px;
    }
    .modal .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .note{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.45}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="t1">Know It All?</div>
          <div class="t2">Host Screen</div>
        </div>
      </div>
      <div class="actions">
        <span class="pill">Room: <b id="roomCode">—</b></span>
        <span class="pill">Players: <b id="playerCount">0</b></span>
        <button class="btn danger" id="btnResetAll" disabled>Reset Game</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Main host content -->
      <div class="card">
        <h2>Startup</h2>
        <div class="muted small">Create a room, share the QR/link, then start.</div>
        <div class="divider"></div>

        <div class="row">
          <div style="flex:1;min-width:220px">
            <label class="small muted">Game length</label>
            <select id="gameLength">
              <option value="50">50 questions</option>
              <option value="100">100 questions</option>
              <option value="150">150 questions</option>
            </select>
          </div>
          <div style="flex:1;min-width:220px">
            <label class="small muted">Room status</label>
            <input id="roomStatus" value="Not created" disabled/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn orange" id="btnCreateRoom">Create Room</button>
          <button class="btn orange" id="btnStartGame" disabled>Start Game</button>
        </div>

        <div class="divider"></div>

        <div class="qrWrap">
          <div>
            <div class="small muted" style="margin-bottom:8px">Join QR</div>
            <div id="qr"></div>
          </div>
          <div style="flex:1;min-width:220px">
            <div class="small muted">Join link</div>
            <input id="joinLink" readonly value="Create a room first..." />
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnCopyLink" disabled>Copy link</button>
              <button class="btn" id="btnShareWhatsApp" disabled>Share WhatsApp</button>
              <button class="btn" id="btnShareMessenger" disabled>Share Messenger</button>
            </div>
            <div class="note">
              If “Share” doesn’t open an app, use Copy Link and paste into WhatsApp / Messenger.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- GAME PANEL -->
        <div id="gamePanel" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div class="muted small">Question</div>
              <div class="qTitle" id="qText">—</div>
            </div>
            <div style="text-align:right;min-width:160px">
              <div class="muted small">Timer</div>
              <div class="timerBig"><span id="timeLeft">20</span>s</div>
              <div class="muted small">Q <span id="qNum">0</span>/<span id="qTotal">0</span></div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="answers" id="answersHost"></div>

          <div class="divider"></div>
          <div class="hostControls">
            <button class="btn orange" id="btnReveal" disabled>Reveal Answer</button>
            <button class="btn orange" id="btnNext" disabled>Next Question</button>
            <button class="btn danger" id="btnResetRoom" disabled>Reset Room</button>
          </div>

          <div class="note">
            Reveal triggers the leaderboard popup on all phones.
            If anyone hits a 5-streak perk, the game pauses until they choose Claim or Sabotage.
          </div>
        </div>
      </div>

      <!-- RIGHT: Always-on leaderboard -->
      <div class="card">
        <h2>Leaderboard (Live)</h2>
        <div class="muted small">Always visible for the host.</div>
        <div class="divider"></div>
        <div class="plist" id="playersList"></div>
      </div>
    </div>
  </div>

  <button class="rulesBtn" id="btnRules">Rules</button>

  <!-- Rules Modal -->
  <div class="modalBack" id="rulesBack">
    <div class="modal">
      <div class="modalTop">
        <h3>Rules & How to Play</h3>
        <button class="btn" id="rulesClose">Close</button>
      </div>
      <div class="note" style="font-size:13px;line-height:1.55;color:#e9e9e9">
        <b>Know It All?</b> is a fast-paced live quiz for up to <b>20 players</b> per room.<br><br>

        <b>How it works</b><br>
        1) Host creates a room and shares the QR/link.<br>
        2) Players join with a nickname and wait.<br>
        3) Each question has <b>20 seconds</b>. Players pick one answer (locked).<br>
        4) Host presses <b>Reveal</b> to show the correct answer and update scores.<br>
        5) A leaderboard popup appears on all phones after each reveal.<br><br>

        <b>Points</b><br>
        • Correct answers earn up to <b>100 points</b> depending on speed.<br><br>

        <b>Streak Perk (5 correct in a row)</b><br>
        When a player reaches a 5-correct streak, the game pauses after reveal until they choose:<br>
        • <b>Claim +20</b> OR<br>
        • <b>Sabotage</b> one player (they can’t answer the next question).<br><br>

        <b>Power Buttons (Players)</b><br>
        • <b>CHEAT</b> (1 use per game): instantly selects the correct answer.<br>
        • <b>HELP</b> (3 uses per game): removes 2 wrong answers immediately (50/50).<br><br>
      </div>
    </div>
  </div>

  <!-- QRCode lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    // Firebase (your config)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
      collection, query, orderBy, getDocs, serverTimestamp, writeBatch
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClio_l3dpOesNw6tHNLDINOjWNDea0hSk",
      authDomain: "knowitall-a47a1.firebaseapp.com",
      projectId: "knowitall-a47a1",
      storageBucket: "knowitall-a47a1.firebasestorage.app",
      messagingSenderId: "975815651315",
      appId: "1:975815651315:web:7a5e981548448b382aec86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Utilities ----------
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function makeRoomCode(){
      const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<5;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function mulberry32(seed){
      return function(){
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function seededShuffle(arr, seed){
      const r = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(r()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function hashSeed(seed, idx){ return (seed * 1000003 + idx * 9176) >>> 0; }

    // Fetch 2000 bank (4 files)
    let BANK = null;
    async function loadBank(){
      if(BANK) return BANK;
      const files = [
        "./question_bank_part1.json",
        "./question_bank_part2.json",
        "./question_bank_part3.json",
        "./question_bank_part4.json"
      ];
      const parts = [];
      for(const f of files){
        const res = await fetch(f, { cache:"no-store" });
        if(!res.ok) throw new Error("Missing file: " + f);
        const arr = await res.json();
        if(!Array.isArray(arr)) throw new Error("Bad JSON array in " + f);
        parts.push(arr);
      }
      BANK = parts.flat();
      return BANK;
    }

    function buildChoices(question, bank, seed, qIndex){
      const r = mulberry32(hashSeed(seed, qIndex));
      const correct = String(question.answer);
      const pool = bank.filter(q => String(q.answer) !== correct).map(q => String(q.answer));
      const decoys = new Set();
      while(decoys.size < 3 && pool.length){
        const cand = pool[Math.floor(r()*pool.length)];
        if(cand && cand !== correct) decoys.add(cand);
      }
      const choices = [correct, ...Array.from(decoys).slice(0,3)];
      for(let i=choices.length-1;i>0;i--){
        const j = Math.floor(r()*(i+1));
        [choices[i], choices[j]] = [choices[j], choices[i]];
      }
      return choices;
    }

    // ---------- UI refs ----------
    const roomCodeEl = document.getElementById("roomCode");
    const playerCountEl = document.getElementById("playerCount");
    const playersListEl = document.getElementById("playersList");

    const btnCreateRoom = document.getElementById("btnCreateRoom");
    const btnStartGame = document.getElementById("btnStartGame");
    const btnReveal = document.getElementById("btnReveal");
    const btnNext = document.getElementById("btnNext");
    const btnResetRoom = document.getElementById("btnResetRoom");
    const btnResetAll = document.getElementById("btnResetAll");

    const roomStatusEl = document.getElementById("roomStatus");
    const gameLengthSel = document.getElementById("gameLength");

    const gamePanel = document.getElementById("gamePanel");
    const qTextEl = document.getElementById("qText");
    const answersHostEl = document.getElementById("answersHost");
    const timeLeftEl = document.getElementById("timeLeft");
    const qNumEl = document.getElementById("qNum");
    const qTotalEl = document.getElementById("qTotal");

    const joinLinkEl = document.getElementById("joinLink");
    const btnCopyLink = document.getElementById("btnCopyLink");
    const btnShareWhatsApp = document.getElementById("btnShareWhatsApp");
    const btnShareMessenger = document.getElementById("btnShareMessenger");

    const rulesBack = document.getElementById("rulesBack");
    document.getElementById("btnRules").onclick = ()=> rulesBack.style.display="flex";
    document.getElementById("rulesClose").onclick = ()=> rulesBack.style.display="none";

    // ---------- Room state ----------
    let roomCode = null;
    let roomUnsub = null;
    let playersUnsub = null;
    let roomDocRef = null;
    let playersColRef = null;

    let playersCache = [];
    let currentRoom = null;
    let tickTimer = null;

    function baseUrl(){
      return window.location.href.replace(/host\.html.*$/,"");
    }
    function makeJoinUrl(code){
      return baseUrl() + "player.html?room=" + encodeURIComponent(code);
    }
    function shareMessage(url){
      return `Just started a quiz game “Know It All?” — fancy joining in?\n${url}`;
    }

    function renderQR(code){
      const qrEl = document.getElementById("qr");
      qrEl.innerHTML = "";
      const url = makeJoinUrl(code);
      new QRCode(qrEl, { text:url, width:168, height:168, correctLevel: QRCode.CorrectLevel.H });
    }

    function updateStartButton(){
      // ✅ Fix: always re-evaluate using the latest room + latest players
      const canStart = !!currentRoom
        && currentRoom.status === "lobby"
        && playersCache.length >= 1;

      btnStartGame.disabled = !canStart;
    }

    function renderPlayersList(players){
      playersListEl.innerHTML = "";
      if(players.length === 0){
        const d = document.createElement("div");
        d.className="muted small";
        d.textContent="No players yet. Share the QR/link.";
        playersListEl.appendChild(d);
        return;
      }
      players.forEach((p, idx)=>{
        const row = document.createElement("div");
        row.className = "pitem";
        const left = document.createElement("div");
        left.innerHTML = `<div class="pname">#${idx+1} ${escapeHtml(p.nick||"Player")}</div>
                          <div class="psub">Streak: ${p.streak||0} • Cheat: ${(p.cheatUsed? "used":"ready")} • Help: ${p.helpUsed||0}/3</div>`;
        const right = document.createElement("div");
        const sabotaged = p.sabotagedNext ? `<span class="tag bad">SABOTAGED</span>` : `<span class="tag good">OK</span>`;
        right.innerHTML = `<div class="pscore">${p.score||0}</div>${sabotaged}`;
        row.appendChild(left);
        row.appendChild(right);
        playersListEl.appendChild(row);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    async function createRoom(){
      const code = makeRoomCode();
      const seed = randInt(1, 2_000_000_000);
      const gameLen = parseInt(gameLengthSel.value,10);

      const bank = await loadBank();
      if(bank.length < 1000) throw new Error("Question bank not loaded.");

      roomCode = code;
      roomDocRef = doc(db, "rooms", roomCode);
      playersColRef = collection(db, "rooms", roomCode, "players");

      await setDoc(roomDocRef, {
        createdAt: serverTimestamp(),
        status: "lobby",
        questionCount: gameLen,
        seed,
        qIndex: 0,
        qStartMs: null,
        revealAtMs: null,
        awaitingPerkFor: [],
        lastRevealSummary: null,
        sabotageNext: {},
        finishedAt: null
      });

      // UI
      roomCodeEl.textContent = roomCode;
      roomStatusEl.value = "Lobby (waiting for players)";
      renderQR(roomCode);

      const url = makeJoinUrl(roomCode);
      joinLinkEl.value = url;
      btnCopyLink.disabled = false;
      btnShareWhatsApp.disabled = false;
      btnShareMessenger.disabled = false;

      btnResetAll.disabled = false;
      btnResetRoom.disabled = false;

      bindRoomListeners();
    }

    function bindRoomListeners(){
      if(roomUnsub) roomUnsub();
      if(playersUnsub) playersUnsub();

      roomUnsub = onSnapshot(roomDocRef, async (snap)=>{
        if(!snap.exists()) return;
        currentRoom = snap.data();

        roomStatusEl.value = currentRoom.status;
        qTotalEl.textContent = String(currentRoom.questionCount || 0);

        // show/hide game panel
        const inGame = currentRoom.status !== "lobby";
        gamePanel.style.display = inGame ? "" : "none";

        btnReveal.disabled = !(currentRoom.status === "question");
        btnNext.disabled = !(currentRoom.status === "reveal");
        btnResetRoom.disabled = false;

        updateStartButton();

        if(inGame){
          await renderHostQuestion(currentRoom);
          syncHostTimer(currentRoom);
        } else {
          if(tickTimer) clearInterval(tickTimer);
          timeLeftEl.textContent = "20";
        }
      });

      playersUnsub = onSnapshot(query(playersColRef, orderBy("score","desc")), (snap)=>{
        playersCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        playerCountEl.textContent = String(playersCache.length);
        renderPlayersList(playersCache);

        // ✅ Fix: also re-check Start Game when players change
        updateStartButton();
      });
    }

    async function renderHostQuestion(room){
      const bank = await loadBank();
      const order = seededShuffle(bank, room.seed).slice(0, room.questionCount);
      const qIndex = room.qIndex || 0;
      const q = order[Math.min(qIndex, order.length-1)];
      if(!q){ qTextEl.textContent = "No question loaded."; return; }

      qTextEl.textContent = q.text;
      qNumEl.textContent = String(qIndex + 1);

      const choices = buildChoices(q, order, room.seed, qIndex);
      const reveal = (room.status === "reveal" || room.status === "awaitingPerks" || room.status === "final");
      const correct = String(q.answer);

      answersHostEl.innerHTML = "";
      choices.forEach((choice)=>{
        const div = document.createElement("div");
        div.className = "ansBtn";
        div.textContent = choice;

        if(reveal){
          if(choice === correct) div.classList.add("correct");
          else div.classList.add("wrong");
        }
        answersHostEl.appendChild(div);
      });
    }

    function syncHostTimer(room){
      if(tickTimer) clearInterval(tickTimer);

      if(room.status === "question" && room.qStartMs){
        tickTimer = setInterval(()=>{
          const now = Date.now();
          const left = Math.max(0, Math.ceil((room.qStartMs + 20000 - now)/1000));
          timeLeftEl.textContent = String(left);
        }, 200);
      } else {
        timeLeftEl.textContent = "20";
      }
    }

    async function startGame(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();
      if(room.status !== "lobby") return;

      // Clear all players for a clean start
      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      pSnap.forEach(d=>{
        batch.update(d.ref, {
          score: 0,
          streak: 0,
          lastAnswer: null,
          lastAnswerMs: null,
          lastCorrect: null,
          cheatUsed: false,
          helpUsed: 0,
          pendingPerk: false,
          sabotagedNext: false
        });
      });

      batch.update(roomDocRef, {
        status: "question",
        qIndex: 0,
        qStartMs: Date.now(),
        revealAtMs: null,
        awaitingPerkFor: [],
        lastRevealSummary: null,
        sabotageNext: {},
        finishedAt: null
      });

      await batch.commit();
    }

    async function revealAnswer(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();
      if(room.status !== "question") return;

      const bank = await loadBank();
      const order = seededShuffle(bank, room.seed).slice(0, room.questionCount);
      const qIndex = room.qIndex || 0;
      const q = order[qIndex];
      const correct = String(q.answer);

      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      const awaiting = [];

      pSnap.forEach(docSnap=>{
        const pid = docSnap.id;
        const p = docSnap.data();

        const sabotaged = !!p.sabotagedNext;
        const answer = p.lastAnswer;
        const answerMs = p.lastAnswerMs;

        let lastCorrect = false;
        let scoreAdd = 0;
        let newStreak = p.streak || 0;

        if(!sabotaged && answer != null){
          lastCorrect = (String(answer) === correct);
          if(lastCorrect){
            const start = room.qStartMs || Date.now();
            const elapsed = Math.max(0, Math.min(20000, (answerMs||Date.now()) - start));
            const timeLeft = Math.max(0, 20000 - elapsed);
            scoreAdd = Math.round(100 * (timeLeft / 20000));
            newStreak += 1;
          } else {
            newStreak = 0;
          }
        } else {
          lastCorrect = false;
          newStreak = 0;
        }

        const updates = {
          lastCorrect,
          score: (p.score||0) + scoreAdd,
          streak: newStreak,
          pendingPerk: false,
          lastAnswer: null,
          lastAnswerMs: null,
          sabotagedNext: false
        };

        if(newStreak > 0 && newStreak % 5 === 0 && lastCorrect){
          updates.pendingPerk = true;
          awaiting.push(pid);
        }

        batch.update(docSnap.ref, updates);
      });

      batch.update(roomDocRef, {
        status: awaiting.length ? "awaitingPerks" : "reveal",
        revealAtMs: Date.now(),
        awaitingPerkFor: awaiting
      });

      await batch.commit();
    }

    async function nextQuestion(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();

      if(room.status !== "reveal") return;

      const nextIndex = (room.qIndex||0) + 1;
      if(nextIndex >= (room.questionCount||0)){
        await updateDoc(roomDocRef, { status:"final", finishedAt: Date.now() });
        return;
      }

      await updateDoc(roomDocRef, {
        status: "question",
        qIndex: nextIndex,
        qStartMs: Date.now(),
        revealAtMs: null
      });
    }

    async function resetRoom(){
      if(!roomDocRef) return;
      if(!confirm("Reset room back to lobby and clear scores?")) return;

      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      pSnap.forEach(d=>{
        batch.update(d.ref,{
          score:0, streak:0,
          lastAnswer:null, lastAnswerMs:null, lastCorrect:null,
          cheatUsed:false, helpUsed:0,
          pendingPerk:false, sabotagedNext:false
        });
      });
      batch.update(roomDocRef,{
        status:"lobby",
        qIndex:0,
        qStartMs:null,
        revealAtMs:null,
        awaitingPerkFor:[],
        lastRevealSummary:null,
        sabotageNext:{},
        finishedAt:null
      });
      await batch.commit();
    }

    // Share
    btnCopyLink.onclick = async ()=>{
      await navigator.clipboard.writeText(joinLinkEl.value);
      alert("Link copied!");
    };
    btnShareWhatsApp.onclick = ()=>{
      const msg = encodeURIComponent(shareMessage(joinLinkEl.value));
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    };
    btnShareMessenger.onclick = ()=>{
      const shareUrl = encodeURIComponent(joinLinkEl.value);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`, "_blank");
    };

    // Buttons
    btnCreateRoom.onclick = async ()=>{
      try{
        btnCreateRoom.disabled = true;
        await createRoom();
      }catch(e){
        console.error(e);
        alert("Create room failed: " + e.message);
      }finally{
        btnCreateRoom.disabled = false;
      }
    };

    btnStartGame.onclick = ()=> startGame().catch(e=>alert(e.message));
    btnReveal.onclick = ()=> revealAnswer().catch(e=>alert(e.message));
    btnNext.onclick = ()=> nextQuestion().catch(e=>alert(e.message));
    btnResetRoom.onclick = ()=> resetRoom().catch(e=>alert(e.message));
    btnResetAll.onclick = ()=> resetRoom().catch(e=>alert(e.message));
  </script>
</body>
</html>
