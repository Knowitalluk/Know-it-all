<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Know It All? — Host</title>

  <style>
    :root{
      --bg:#070707;
      --panel:#0e0e0e;
      --border:#232323;
      --text:#f3f3f3;
      --muted:#bdbdbd;
      --orange:#ff7a18;
      --good:#29d17d;
      --bad:#ff4b4b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(255,122,24,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,122,24,.10), transparent 65%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh;
    }
    .wrap{max-width:1920px;margin:0 auto;padding:14px 14px 22px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(17,17,17,.85), rgba(10,10,10,.65));
      box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:950}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,154,61,.9), rgba(255,122,24,.35) 40%, rgba(0,0,0,.5) 75%),
        linear-gradient(180deg, rgba(255,122,24,.25), rgba(255,122,24,.06));
      border:1px solid rgba(255,122,24,.35);
      box-shadow: 0 12px 30px rgba(255,122,24,.12);
    }
    .brand .t1{
      font-size:24px; /* bigger title */
      letter-spacing:.4px;
      line-height:1.05;
    }
    .brand .t2{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}

    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(10,10,10,.6); color:var(--muted); font-weight:900;
    }
    .pill b{color:var(--text)}
    .pill.orange{border-color:rgba(255,122,24,.35); color:rgba(255,255,255,.9)}
    .pill.orange b{color:var(--orange)}

    .btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(20,20,20,.9), rgba(10,10,10,.85));
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      font-weight:950; cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.3);
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.12);border-color:rgba(255,122,24,.35)}
    .btn:active{transform:translateY(1px)}
    .btn.orange{
      border-color:rgba(255,122,24,.45);
      background:linear-gradient(180deg, rgba(255,122,24,.22), rgba(10,10,10,.88));
      box-shadow: 0 14px 40px rgba(255,122,24,.12);
    }
    .btn.danger{
      border-color: rgba(255,75,75,.35);
      background: linear-gradient(180deg, rgba(255,75,75,.20), rgba(10,10,10,.88));
    }
    .btn:disabled{opacity:.45;cursor:not-allowed;filter:saturate(.6)}

    .layout{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media(max-width:1100px){ .layout{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:linear-gradient(180deg, rgba(17,17,17,.75), rgba(9,9,9,.65));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .card h2{margin:6px 0 10px;font-size:16px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input, select{
      width:100%;
      padding:11px 12px;border-radius:14px;
      border:1px solid var(--border);
      background:rgba(8,8,8,.65);
      color:var(--text);
      outline:none;
      font-weight:900;
    }

    .qrWrap{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap}
    #qr{
      width:188px;height:188px;border-radius:18px;background:#fff;padding:10px;
      border:2px solid rgba(255,122,24,.85);
      box-shadow: 0 12px 35px rgba(255,122,24,.18);
      overflow:hidden;
    }

    .qTitle{font-size:22px;font-weight:950;letter-spacing:.3px;line-height:1.25;margin:8px 0 10px}
    .answers{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:720px){ .answers{grid-template-columns:1fr} }
    .ansBtn{
      text-align:left;border-radius:16px;padding:12px 12px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,16,16,.85), rgba(8,8,8,.8));
      font-weight:950;color:var(--text);
      min-height:50px;
      opacity:.95;
    }
    .ansBtn.correct{
      border-color: rgba(41,209,125,.35);
      background: linear-gradient(180deg, rgba(41,209,125,.18), rgba(8,8,8,.85));
    }
    .ansBtn.wrong{opacity:.55}

    .timerBig{font-size:28px;font-weight:950;color:var(--orange);letter-spacing:1px}
    .hostControls{display:flex;gap:10px;flex-wrap:wrap}
    .hostControls .btn{flex:1 1 160px}

    .plist{display:flex;flex-direction:column;gap:8px;max-height: calc(100vh - 210px); overflow:auto; padding-right:6px}
    .pitem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.06);
      background:rgba(10,10,10,.5);
    }
    .pname{font-weight:950}
    .psub{font-size:12px;color:var(--muted);font-weight:800}
    .pscore{font-weight:980;color:var(--orange)}
    .tag{font-size:12px;font-weight:950;color:#000;background:var(--orange);padding:4px 8px;border-radius:999px}
    .tag.bad{background:var(--bad); color:#fff}
    .tag.good{background:var(--good); color:#000}

    .rulesBtn{
      position:fixed;right:16px;bottom:16px;z-index:1000;
      border-radius:999px;padding:10px 14px;
      background:linear-gradient(180deg, rgba(255,122,24,.25), rgba(10,10,10,.85));
      border:1px solid rgba(255,122,24,.45);
      font-weight:980;cursor:pointer;
      box-shadow: 0 14px 44px rgba(255,122,24,.12);
      color:#fff; /* visible */
    }

    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none;align-items:center;justify-content:center;z-index:999;
      padding:18px;
    }
    .modal{
      width:min(740px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,122,24,.35);
      background: linear-gradient(180deg, rgba(16,16,16,.92), rgba(8,8,8,.90));
      box-shadow: 0 25px 80px rgba(0,0,0,.6);
      padding:14px;
    }
    .modal .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .note{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.45}

    .banner{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,122,24,.25);
      background: linear-gradient(180deg, rgba(255,122,24,.16), rgba(8,8,8,.82));
      padding:10px 12px;
      font-weight:950;
      color:rgba(255,255,255,.92);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="t1">Know It All?</div>
          <div class="t2">Host Screen</div>
        </div>
      </div>
      <div class="actions">
        <span class="pill orange">Room: <b id="roomCode">—</b></span>
        <span class="pill">Players: <b id="playerCount">0</b></span>
        <button class="btn danger" id="btnResetGameTop" disabled>Reset Game</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="card">
        <!-- Lobby UI -->
        <div id="lobbyUI">
          <h2>Startup</h2>
          <div class="muted small">Create a room, share the QR/link, then start.</div>
          <div class="divider"></div>

          <div class="row">
            <div style="flex:1;min-width:220px">
              <label class="small muted">Game length</label>
              <select id="gameLength">
                <option value="50">50 questions</option>
                <option value="100">100 questions</option>
                <option value="150">150 questions</option>
              </select>
            </div>
            <div style="flex:1;min-width:220px">
              <label class="small muted">Room status</label>
              <input id="roomStatus" value="Not created" disabled/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn orange" id="btnCreateRoom">Create Room</button>
            <button class="btn orange" id="btnStartGame" disabled>Start Game</button>
          </div>

          <div class="divider"></div>

          <div class="qrWrap">
            <div>
              <div class="small muted" style="margin-bottom:8px">Join QR</div>
              <div id="qr"></div>
              <!-- ✅ room code shown under QR ONLY during setup -->
              <div class="banner" style="margin-top:10px;text-align:center">
                Room Code: <span id="roomCodeUnder">—</span>
              </div>
            </div>
            <div style="flex:1;min-width:220px">
              <div class="small muted">Join link</div>
              <input id="joinLink" readonly value="Create a room first..." />
              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnCopyLink" disabled>Copy link</button>
                <button class="btn" id="btnShareWhatsApp" disabled>Share WhatsApp</button>
                <button class="btn" id="btnShareMessenger" disabled>Share Messenger</button>
              </div>
              <div class="note">
                Fixed 20s per question. Maths capped at 10 per 50. Decoys match answer type (no giveaways).
              </div>
            </div>
          </div>
        </div>

        <!-- Game UI -->
        <div id="gameUI" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div class="muted small">Question</div>
              <div class="qTitle" id="qText">—</div>
            </div>
            <div style="text-align:right;min-width:160px">
              <div class="muted small">Timer</div>
              <div class="timerBig"><span id="timeLeft">20</span>s</div>
              <div class="muted small">Q <span id="qNum">0</span>/<span id="qTotal">0</span></div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="answers" id="answersHost"></div>

          <div class="divider"></div>
          <div class="hostControls">
            <button class="btn orange" id="btnReveal" disabled>Reveal Answer</button>
            <button class="btn orange" id="btnNext" disabled>Next Question</button>
            <button class="btn danger" id="btnResetGame" disabled>Reset Game</button>
          </div>

          <div class="note" id="hostPauseNote" style="display:none">
            Game paused: waiting for streak selections (Claim/Sabotage).
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>Leaderboard (Live)</h2>
        <div class="muted small">Always visible for the host.</div>
        <div class="divider"></div>
        <div class="plist" id="playersList"></div>
      </div>
    </div>
  </div>

  <button class="rulesBtn" id="btnRules">Rules</button>

  <div class="modalBack" id="rulesBack">
    <div class="modal">
      <div class="modalTop">
        <h3>Rules & How to Play</h3>
        <button class="btn" id="rulesClose">Close</button>
      </div>
      <div class="note" style="font-size:13px;line-height:1.55;color:#e9e9e9">
        <b>Know It All?</b> is a live quiz for up to <b>20 players</b> per room.<br><br>

        <b>How it works</b><br>
        1) Host creates a room and shares the QR/link.<br>
        2) Players join with a nickname and wait.<br>
        3) Each question has <b>20 seconds</b>. Players pick one answer (locked).<br>
        4) Host presses <b>Reveal</b> to show correct answer and update scores.<br>
        5) A leaderboard popup appears after each reveal on player phones.<br><br>

        <b>Points</b><br>
        • Up to <b>100 points</b> per question depending on speed.<br><br>

        <b>Streak Perk (every 5 correct in a row)</b><br>
        • The player must choose: <b>Claim +20</b> OR <b>Sabotage</b> a player.<br>
        • Sabotage means the victim cannot answer the <b>next question</b>.<br>
        • The game pauses until all streak players have chosen.<br><br>

        <b>Powers</b><br>
        • <b>CHEAT</b> (1 use per game): instantly selects the correct answer.<br>
        • <b>HELP</b> (3 uses per game): removes 2 wrong answers immediately (50/50).
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot,
      collection, query, orderBy, getDocs, serverTimestamp, writeBatch,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyClio_l3dpOesNw6tHNLDINOjWNDea0hSk",
      authDomain: "knowitall-a47a1.firebaseapp.com",
      projectId: "knowitall-a47a1",
      storageBucket: "knowitall-a47a1.firebasestorage.app",
      messagingSenderId: "975815651315",
      appId: "1:975815651315:web:7a5e981548448b382aec86"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- Sound (no background music) ----------
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    function ctx(){ if(!audioCtx) audioCtx = new AudioCtx(); return audioCtx; }
    function beep(freq=440, dur=0.06, type="sine", vol=0.08){
      const c = ctx();
      const o = c.createOscillator();
      const g = c.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = vol;
      o.connect(g); g.connect(c.destination);
      o.start();
      o.stop(c.currentTime + dur);
    }
    function sClick(){ beep(560, 0.03, "square", 0.04); }
    function sReveal(){ beep(740, 0.06, "sawtooth", 0.06); setTimeout(()=>beep(980,0.08,"sawtooth",0.06), 70); }

    // ---------- RNG helpers ----------
    function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
    function mulberry32(seed){
      return function(){
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function seededShuffle(arr, seed){
      const r = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(r()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function makeRoomCode(){
      const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<5;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    // ---------- Question bank loading ----------
    let BANK = null;
    async function loadBank(){
      if(BANK) return BANK;
      const files = [
        "./question_bank_part1.json",
        "./question_bank_part2.json",
        "./question_bank_part3.json",
        "./question_bank_part4.json"
      ];
      const parts = [];
      for(const f of files){
        const res = await fetch(f, { cache:"no-store" });
        if(!res.ok) throw new Error("Missing file: " + f);
        const arr = await res.json();
        if(!Array.isArray(arr)) throw new Error("Bad JSON in " + f);
        parts.push(arr);
      }
      BANK = parts.flat();
      return BANK;
    }

    // ---------- Maths detection (category OR heuristic) ----------
    function isMathQuestion(q){
      const cat = String(q.category||"").toLowerCase();
      if(cat === "math" || cat === "maths") return true;
      const t = String(q.text||"").toLowerCase();
      const hasDigits = /\d/.test(t);
      const hasOps = /[+\-*/=]|×|÷|\bplus\b|\bminus\b|\btimes\b|\bdivid(ed|e)\b|\bsolve\b|\bcalculate\b/.test(t);
      const looksLikeEquation = /(\d+\s*[+\-*/×÷]\s*\d+)/.test(t);
      return (hasDigits && (hasOps || looksLikeEquation));
    }

    // ---------- Build game set with maths cap ----------
    function buildQuestionSet(bank, total, seed){
      const mathsCap = Math.floor(total / 5); // 10 per 50
      const maths = [];
      const non = [];
      for(const q of bank){
        (isMathQuestion(q) ? maths : non).push(q);
      }
      const m = seededShuffle(maths, seed + 11).slice(0, mathsCap);
      const n = seededShuffle(non, seed + 22).slice(0, total - m.length);
      return seededShuffle([...m, ...n], seed + 33);
    }

    function isNumericAnswer(ans){
      const s = String(ans).trim();
      return /^-?\d+(\.\d+)?$/.test(s);
    }

    // ---------- Type-matched choices ----------
    function buildChoices(question, bank, seed, qIndex){
      const r = mulberry32(seed + qIndex * 1000 + 77);
      const correct = String(question.answer).trim();
      const wantNumber = isNumericAnswer(correct);

      let pool = bank
        .map(q => String(q.answer).trim())
        .filter(a => a && a !== correct)
        .filter(a => isNumericAnswer(a) === wantNumber);

      pool = Array.from(new Set(pool));
      const choices = [correct];

      while(choices.length < 4){
        if(pool.length){
          const idx = Math.floor(r() * pool.length);
          const pick = pool.splice(idx,1)[0];
          if(!choices.includes(pick)) choices.push(pick);
        } else {
          if(wantNumber){
            const n = Number(correct);
            const delta = (Math.floor(r()*9)+1) * (r() < 0.5 ? -1 : 1);
            const gen = String(Number.isFinite(n) ? (n + delta) : (Math.floor(r()*200)+1));
            if(!choices.includes(gen)) choices.push(gen);
          } else {
            const gen = "None of the above";
            if(!choices.includes(gen)) choices.push(gen);
          }
        }
      }
      return seededShuffle(choices, seed + qIndex * 17 + 123);
    }

    // ---------- UI refs ----------
    const roomCodeEl = document.getElementById("roomCode");
    const roomCodeUnderEl = document.getElementById("roomCodeUnder");
    const playerCountEl = document.getElementById("playerCount");
    const playersListEl = document.getElementById("playersList");
    const roomStatusEl = document.getElementById("roomStatus");

    const lobbyUI = document.getElementById("lobbyUI");
    const gameUI = document.getElementById("gameUI");

    const btnCreateRoom = document.getElementById("btnCreateRoom");
    const btnStartGame = document.getElementById("btnStartGame");
    const btnReveal = document.getElementById("btnReveal");
    const btnNext = document.getElementById("btnNext");
    const btnResetGame = document.getElementById("btnResetGame");
    const btnResetGameTop = document.getElementById("btnResetGameTop");
    const hostPauseNote = document.getElementById("hostPauseNote");

    const gameLengthSel = document.getElementById("gameLength");
    const qTextEl = document.getElementById("qText");
    const answersHostEl = document.getElementById("answersHost");
    const timeLeftEl = document.getElementById("timeLeft");
    const qNumEl = document.getElementById("qNum");
    const qTotalEl = document.getElementById("qTotal");

    const joinLinkEl = document.getElementById("joinLink");
    const btnCopyLink = document.getElementById("btnCopyLink");
    const btnShareWhatsApp = document.getElementById("btnShareWhatsApp");
    const btnShareMessenger = document.getElementById("btnShareMessenger");

    const rulesBack = document.getElementById("rulesBack");
    document.getElementById("btnRules").onclick = ()=> rulesBack.style.display="flex";
    document.getElementById("rulesClose").onclick = ()=> rulesBack.style.display="none";

    // ---------- Room state ----------
    let roomCode = null;
    let roomDocRef = null;
    let playersColRef = null;

    let roomUnsub = null;
    let playersUnsub = null;

    let currentRoom = null;
    let playersCache = [];
    let tickTimer = null;

    function baseUrl(){
      return window.location.href.replace(/host\.html.*$/,"");
    }
    function makeJoinUrl(code){
      return baseUrl() + "player.html?room=" + encodeURIComponent(code);
    }
    function shareMessage(url){
      return `Just started a quiz game “Know It All?” — fancy joining in?\n${url}`;
    }
    function renderQR(code){
      const qrEl = document.getElementById("qr");
      qrEl.innerHTML = "";
      const url = makeJoinUrl(code);
      new QRCode(qrEl, { text:url, width:168, height:168, correctLevel: QRCode.CorrectLevel.H });
    }

    function updateStartButton(){
      const canStart = !!currentRoom && currentRoom.status === "lobby" && playersCache.length >= 1;
      btnStartGame.disabled = !canStart;
    }

    function applyHostViewMode(){
      if(!currentRoom) return;
      const inGame = currentRoom.status !== "lobby";
      lobbyUI.style.display = inGame ? "none" : "";
      gameUI.style.display = inGame ? "" : "none";
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function renderPlayersList(players){
      playersListEl.innerHTML = "";
      if(players.length === 0){
        const d = document.createElement("div");
        d.className="muted small";
        d.textContent="No players yet.";
        playersListEl.appendChild(d);
        return;
      }
      players.forEach((p, idx)=>{
        const row = document.createElement("div");
        row.className="pitem";
        const left = document.createElement("div");
        left.innerHTML = `<div class="pname">#${idx+1} ${escapeHtml(p.nick||"Player")}</div>
                          <div class="psub">Streak: ${p.streak||0} • Cheat: ${(p.cheatUsed? "used":"ready")} • Help: ${p.helpUsed||0}/3</div>`;
        const right = document.createElement("div");
        const st = p.sabotagedNext ? `<span class="tag bad">SABOTAGED</span>` : `<span class="tag good">OK</span>`;
        const perk = p.pendingPerk ? ` <span class="tag" style="background:#fff;color:#000">PERK</span>` : "";
        right.innerHTML = `<div class="pscore">${p.score||0}</div>${st}${perk}`;
        row.appendChild(left); row.appendChild(right);
        playersListEl.appendChild(row);
      });
    }

    function syncHostTimer(room){
      if(tickTimer) clearInterval(tickTimer);
      if(room.status === "question" && room.qStartMs){
        tickTimer = setInterval(()=>{
          const left = Math.max(0, Math.ceil((room.qStartMs + 20000 - Date.now())/1000));
          timeLeftEl.textContent = String(left);
        }, 200);
      } else {
        timeLeftEl.textContent = "20";
      }
    }

    async function getOrder(room){
      const bank = await loadBank();
      return buildQuestionSet(bank, room.questionCount || 50, room.seed);
    }

    async function renderHostQuestion(room){
      const order = await getOrder(room);
      const qIndex = room.qIndex || 0;
      const q = order[Math.min(qIndex, order.length-1)];
      if(!q){ qTextEl.textContent = "No question loaded."; return; }

      qTextEl.textContent = q.text;
      qTotalEl.textContent = String(room.questionCount || order.length);
      qNumEl.textContent = String(qIndex + 1);

      const choices = buildChoices(q, order, room.seed, qIndex);
      const reveal = (room.status === "reveal" || room.status === "awaitingPerks" || room.status === "final");
      const correct = String(q.answer).trim();

      answersHostEl.innerHTML = "";
      choices.forEach(choice=>{
        const div = document.createElement("div");
        div.className="ansBtn";
        div.textContent = choice;
        if(reveal){
          if(String(choice).trim() === correct) div.classList.add("correct");
          else div.classList.add("wrong");
        }
        answersHostEl.appendChild(div);
      });
    }

    // ---------- Firestore flow ----------
    async function createRoom(){
      const code = makeRoomCode();
      const seed = randInt(1, 2_000_000_000);
      const gameLen = parseInt(gameLengthSel.value,10);

      const bank = await loadBank();
      if(bank.length < 1000) throw new Error("Question bank not loaded.");

      roomCode = code;
      roomDocRef = doc(db, "rooms", roomCode);
      playersColRef = collection(db, "rooms", roomCode, "players");

      await setDoc(roomDocRef, {
        createdAt: serverTimestamp(),
        status: "lobby",
        questionCount: gameLen,
        seed,
        qIndex: 0,
        qStartMs: null,
        revealAtMs: null,
        awaitingPerkFor: [],
        sabotage: { victimId: null, byId: null, byNick: null, qIndex: null }, // last sabotage record
        finishedAt: null
      });

      roomCodeEl.textContent = roomCode;
      roomCodeUnderEl.textContent = roomCode;
      roomStatusEl.value = "lobby";
      renderQR(roomCode);

      const url = makeJoinUrl(roomCode);
      joinLinkEl.value = url;
      btnCopyLink.disabled = false;
      btnShareWhatsApp.disabled = false;
      btnShareMessenger.disabled = false;

      btnResetGame.disabled = false;
      btnResetGameTop.disabled = false;

      bindRoomListeners();
    }

    function bindRoomListeners(){
      if(roomUnsub) roomUnsub();
      if(playersUnsub) playersUnsub();

      roomUnsub = onSnapshot(roomDocRef, async (snap)=>{
        if(!snap.exists()) return;
        currentRoom = snap.data();

        roomStatusEl.value = currentRoom.status;
        applyHostViewMode();

        // host controls
        const isQuestion = currentRoom.status === "question";
        const isReveal = currentRoom.status === "reveal";
        const isAwait = currentRoom.status === "awaitingPerks";

        btnReveal.disabled = !isQuestion;
        btnNext.disabled = !isReveal; // ✅ cannot continue while awaiting perks

        hostPauseNote.style.display = isAwait ? "" : "none";

        updateStartButton();

        if(currentRoom.status !== "lobby"){
          await renderHostQuestion(currentRoom);
          syncHostTimer(currentRoom);
        } else {
          if(tickTimer) clearInterval(tickTimer);
          timeLeftEl.textContent = "20";
        }
      });

      playersUnsub = onSnapshot(query(playersColRef, orderBy("score","desc")), (snap)=>{
        playersCache = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        playerCountEl.textContent = String(playersCache.length);
        renderPlayersList(playersCache);
        updateStartButton();
      });
    }

    async function startGame(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();
      if(room.status !== "lobby") return;

      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);

      pSnap.forEach(d=>{
        batch.update(d.ref,{
          score:0, streak:0,
          lastAnswer:null, lastAnswerMs:null, lastCorrect:null,
          cheatUsed:false, helpUsed:0,
          helpMasks:{},
          pendingPerk:false,
          sabotagedNext:false,
          sabotageMsg:null
        });
      });

      batch.update(roomDocRef,{
        status:"question",
        qIndex:0,
        qStartMs:Date.now(),
        revealAtMs:null,
        awaitingPerkFor:[],
        sabotage:{ victimId:null, byId:null, byNick:null, qIndex:null },
        finishedAt:null
      });

      await batch.commit();
    }

    async function revealAnswer(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();
      if(room.status !== "question") return;

      sReveal();

      const order = await getOrder(room);
      const qIndex = room.qIndex || 0;
      const q = order[qIndex];
      const correct = String(q.answer).trim();

      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      const awaiting = [];

      pSnap.forEach(docSnap=>{
        const p = docSnap.data();
        const sabotaged = !!p.sabotagedNext;
        const answer = p.lastAnswer;
        const answerMs = p.lastAnswerMs;

        let lastCorrect = false;
        let scoreAdd = 0;
        let newStreak = p.streak || 0;

        if(!sabotaged && answer != null){
          lastCorrect = (String(answer).trim() === correct);
          if(lastCorrect){
            const start = room.qStartMs || Date.now();
            const elapsed = Math.max(0, Math.min(20000, (answerMs||Date.now()) - start));
            const timeLeft = Math.max(0, 20000 - elapsed);
            scoreAdd = Math.round(100 * (timeLeft / 20000));
            newStreak += 1;
          } else {
            newStreak = 0;
          }
        } else {
          newStreak = 0;
        }

        const updates = {
          lastCorrect,
          score: (p.score||0) + scoreAdd,
          streak: newStreak,
          // keep lastAnswer around for player reveal UI
          // but lock in next question by resetting when host advances
          pendingPerk: false,
          sabotagedNext: false
        };

        if(newStreak > 0 && newStreak % 5 === 0 && lastCorrect){
          updates.pendingPerk = true;
          awaiting.push(docSnap.id);
        }

        batch.update(docSnap.ref, updates);
      });

      batch.update(roomDocRef, {
        status: awaiting.length ? "awaitingPerks" : "reveal",
        revealAtMs: Date.now(),
        awaitingPerkFor: awaiting
      });

      await batch.commit();
    }

    async function nextQuestion(){
      const snap = await getDoc(roomDocRef);
      if(!snap.exists()) return;
      const room = snap.data();
      if(room.status !== "reveal") return;

      const nextIndex = (room.qIndex||0) + 1;
      if(nextIndex >= (room.questionCount||0)){
        await updateDoc(roomDocRef, { status:"final", finishedAt: Date.now() });
        return;
      }

      // reset per-question fields on players
      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      pSnap.forEach(d=>{
        batch.update(d.ref,{
          lastAnswer:null,
          lastAnswerMs:null,
          lastCorrect:null,
          // sabotage already applied to "next question" by setting sabotagedNext=true on victim,
          // which will be consumed in revealAnswer() and then cleared there.
        });
      });
      batch.update(roomDocRef, {
        status: "question",
        qIndex: nextIndex,
        qStartMs: Date.now(),
        revealAtMs: null
      });
      await batch.commit();
    }

    async function resetGame(){
      if(!roomDocRef) return;
      if(!confirm("Reset game back to lobby and clear scores?")) return;

      const pSnap = await getDocs(playersColRef);
      const batch = writeBatch(db);
      pSnap.forEach(d=>{
        batch.update(d.ref,{
          score:0, streak:0,
          lastAnswer:null, lastAnswerMs:null, lastCorrect:null,
          cheatUsed:false, helpUsed:0, helpMasks:{},
          pendingPerk:false,
          sabotagedNext:false,
          sabotageMsg:null
        });
      });

      batch.update(roomDocRef,{
        status:"lobby",
        qIndex:0,
        qStartMs:null,
        revealAtMs:null,
        awaitingPerkFor:[],
        sabotage:{ victimId:null, byId:null, byNick:null, qIndex:null },
        finishedAt:null
      });

      await batch.commit();
    }

    // Share buttons
    btnCopyLink.onclick = async ()=>{
      sClick();
      await navigator.clipboard.writeText(joinLinkEl.value);
      alert("Link copied!");
    };
    btnShareWhatsApp.onclick = ()=>{
      sClick();
      const msg = encodeURIComponent(shareMessage(joinLinkEl.value));
      window.open(`https://wa.me/?text=${msg}`, "_blank");
    };
    btnShareMessenger.onclick = ()=>{
      sClick();
      const shareUrl = encodeURIComponent(joinLinkEl.value);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`, "_blank");
    };

    // Buttons
    btnCreateRoom.onclick = async ()=>{
      try{
        sClick();
        btnCreateRoom.disabled = true;
        await createRoom();
      }catch(e){
        console.error(e);
        alert("Create room failed: " + e.message);
      }finally{
        btnCreateRoom.disabled = false;
      }
    };
    btnStartGame.onclick = ()=>{ sClick(); startGame().catch(e=>alert(e.message)); };
    btnReveal.onclick = ()=>{ sClick(); revealAnswer().catch(e=>alert(e.message)); };
    btnNext.onclick = ()=>{ sClick(); nextQuestion().catch(e=>alert(e.message)); };
    btnResetGame.onclick = ()=>{ sClick(); resetGame().catch(e=>alert(e.message)); };
    btnResetGameTop.onclick = ()=>{ sClick(); resetGame().catch(e=>alert(e.message)); };
  </script>
</body>
</html>
